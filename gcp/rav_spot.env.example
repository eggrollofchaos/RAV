# Copy to gcp/rav_spot.env and fill values.
# This file is sourced by scripts/gcp_*.sh wrappers.

# Required GCP/project settings
PROJECT="my-gcp-project"
REGION="us-east1"
SA="my-compute@${PROJECT}.iam.gserviceaccount.com"
BUCKET="my-training-bucket"
IMAGE="us-east1-docker.pkg.dev/${PROJECT}/rav-train/rav-chest:latest"

# Path to your spot runner checkout
RUNNER_DIR="../gcp-spot-runner"

# VM shape + zones
ZONE="us-east1-c"
FALLBACK_ZONES=("us-east1-b" "us-east1-c" "us-east1-d")
MACHINE_TYPE="n1-standard-8"
GPU_TYPE="nvidia-tesla-t4"
BOOT_DISK_SIZE="100"
BOOT_DISK_TYPE="pd-ssd"
# Persistent data cache disk (recommended for CheXpert full/small)
DATA_DISK_ENABLED="true"
DATA_DISK_NAME=""
DATA_DISK_SIZE_GB="600"
DATA_DISK_TYPE="pd-ssd"
DATA_DISK_DEVICE_NAME="spot-data"
DATA_DISK_MOUNT_PATH="/mnt/spot-data"
DATA_DISK_FS_TYPE="ext4"
# Note: with DATA_DISK_ENABLED=true, runner pins launches to ZONE so the same zonal disk can be reattached.

# Job/runtime controls
CONTAINER_NAME="rav-trainer"
CONDA_ENV=""
GPU_TIMEOUT_SEC="600"
MAX_RUNTIME_SEC="172800"
POLL_INTERVAL="120"
HEARTBEAT_STALE_SEC="600"
HEARTBEAT_STALE_MAX="3"
PROGRESS_STALL_POLLS="6"
MAX_RESTARTS="3"
RESTART_BACKOFF_SEC="60"
WALL_CLOCK_DEADLINE=""
DEADLINE_TZ="America/New_York"
OWNER_LOCK_STALE_SEC="300"

# Labels/observability
METADATA_PREFIX="spot"
RUNNER_LABEL="spot-runner"
LOG_LEVEL="INFO"
DISCORD_WEBHOOK_URL=""

# Secret Manager resource for Discord webhook (used by VM for preemption notifications)
# Format: projects/PROJECT/secrets/SECRET_NAME/versions/latest
NOTIFY_SECRET=""

# Optional overrides for wrapper job commands
# SYNC_INTERVAL_SEC controls periodic checkpoint/metrics upload during training.
# Default is 180 seconds when unset.
SYNC_INTERVAL_SEC="180"

# Optional overrides for wrapper job commands.
# If you override these, keep RUN_ID/GCS paths consistent if you still want resume support.
# JOB_COMMAND_PRIMARY="set -euo pipefail; bash scripts/gcp_sync_chexpert_cache.sh --raw-uri gs://${BUCKET}/datasets/chexpert/raw --processed-uri gs://${BUCKET}/datasets/chexpert/processed --cache-root data; bash scripts/gcp_train_with_checkpoint_sync.sh --config configs/primary/chest_chexpert.yaml --eval-split val --sync-interval-sec ${SYNC_INTERVAL_SEC}"
# JOB_COMMAND_POC="set -euo pipefail; bash scripts/gcp_train_with_checkpoint_sync.sh --config configs/poc/chest_pneumonia_binary.yaml --eval-split test --sync-interval-sec ${SYNC_INTERVAL_SEC}"
